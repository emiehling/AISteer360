
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ibm.github.io/AISteer360/reference/algorithms/state_control/cast/">
      
      
        <link rel="prev" href="../base_state_control/">
      
      
        <link rel="next" href="../pasta/">
      
      
        
      
      
      <link rel="icon" href="../../../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>CAST - AISteer360</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cast" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="AISteer360" class="md-header__button md-logo" aria-label="AISteer360" data-md-component="logo">
      
  <img src="../../../../assets/logo_darkmode.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AISteer360
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              CAST
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/IBM/AISteer360" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    IBM/AISteer360
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../.." class="md-tabs__link">
          
  
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../concepts/" class="md-tabs__link">
          
  
  
    
  
  Concepts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../tutorials/" class="md-tabs__link">
          
  
  
    
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../notebooks/" class="md-tabs__link">
          
  
  
    
  
  Notebooks

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../" class="md-tabs__link">
          
  
  
    
  
  API Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="AISteer360" class="md-nav__button md-logo" aria-label="AISteer360" data-md-component="logo">
      
  <img src="../../../../assets/logo_darkmode.png" alt="logo">

    </a>
    AISteer360
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/IBM/AISteer360" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    IBM/AISteer360
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Home
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../home/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../home/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../concepts/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../concepts/controls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Controls
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../concepts/steering_pipelines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Steering pipelines
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../tutorials/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tutorials/add_new_steering_method/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add a steering method
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tutorials/add_new_metric/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add a metric
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tutorials/add_new_use_case/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add a use case
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tutorials/add_new_benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add a benchmark
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../notebooks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Notebooks
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Notebooks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Controls
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Controls
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_1" >
        
          
          <label class="md-nav__link" for="__nav_4_2_1" id="__nav_4_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Input control
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Input control
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/controls/few_shot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Few-shot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2_2" id="__nav_4_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Structural control
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Structural control
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/controls/mergekit_wrapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Running MergeKit methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/controls/trl_wrapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Running TRL methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_3" >
        
          
          <label class="md-nav__link" for="__nav_4_2_3" id="__nav_4_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    State control
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    State control
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/controls/cast/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CAST
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/controls/pasta/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PASTA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_4" >
        
          
          <label class="md-nav__link" for="__nav_4_2_4" id="__nav_4_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Output control
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Output control
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/controls/deal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DeAL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/controls/rad/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/controls/sasa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SASA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/controls/thinking_intervention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Thinking Intervention
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Benchmarks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Benchmarks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/benchmarks/commonsense_mcqa/commonsense_mcqa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Commonsense MCQA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../notebooks/benchmarks/instruction_following/instruction_following/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Instruction following
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Algorithms
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Algorithms
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Core
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2_2" id="__nav_5_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Input control
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Input control
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input_control/base_input_control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Base classes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../input_control/few_shot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FewShot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2_3" >
        
          
          <label class="md-nav__link" for="__nav_5_2_3" id="__nav_5_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Structural control
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Structural control
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structural_control/base_structural_control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Base classes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structural_control/mergekit_wrapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MergeKit wrapper
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structural_control/trl_wrapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TRL wrapper
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2_4" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2_4" id="__nav_5_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    State control
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    State control
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../base_state_control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Base classes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    CAST
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    CAST
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;cast
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" cast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.args" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;args
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" args">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.args._check_layer_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;_check_layer_ids
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;CAST
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" CAST">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._behavior_layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_behavior_layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._condition_layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_condition_layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._condition_met" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_condition_met
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._condition_similarities" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_condition_similarities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._forward_calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_forward_calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._layers_names" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_layers_names
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._layers_states" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_layers_states
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._model_ref" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_model_ref
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.args" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.device" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;device
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;hooks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.model" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.registered" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;registered
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;tokenizer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.__enter__" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__enter__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.__exit__" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__exit__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._apply_ooi_normalization" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_apply_ooi_normalization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._apply_single_behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_apply_single_behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._cast_pre_hook" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_cast_pre_hook
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._compute_similarity" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_compute_similarity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._process_single_condition" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_process_single_condition
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_setup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._use_explained_variance_func" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_use_explained_variance_func
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.get_hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_hooks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.get_model_layer_list" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_model_layer_list
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.register_hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;register_hooks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.remove_hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;remove_hooks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.reset" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;reset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.set_hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;set_hooks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.steer" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;steer
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pasta/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PASTA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2_5" >
        
          
          <label class="md-nav__link" for="__nav_5_2_5" id="__nav_5_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Output control
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Output control
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../output_control/base_output_control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Base classes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../output_control/deal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DeAL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../output_control/rad/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../output_control/sasa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SASA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../output_control/thinking_intervention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ThinkingIntervention
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Evaluation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Evaluation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_1" >
        
          
          <label class="md-nav__link" for="__nav_5_3_1" id="__nav_5_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Metrics
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Metrics
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../evaluation/metrics/base_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Base classes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../evaluation/metrics/generic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Generic
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_1_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3_1_3" id="__nav_5_3_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Custom
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_3_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Custom
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../evaluation/metrics/custom/commonsense_mcqa_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Commonsense MCQA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../evaluation/metrics/custom/instruction_following_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Instruction following
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_2" >
        
          
          <label class="md-nav__link" for="__nav_5_3_2" id="__nav_5_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Use cases
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Use cases
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../evaluation/use_cases/base_use_case/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Base class
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../evaluation/use_cases/commonsense_mcqa_use_case/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Commonsense MCQA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../evaluation/use_cases/instruction_following_use_case/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Instruction following
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../evaluation/benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Benchmark
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;cast
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" cast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.args" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;args
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" args">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.args._check_layer_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;_check_layer_ids
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;CAST
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" CAST">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._behavior_layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_behavior_layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._condition_layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_condition_layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._condition_met" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_condition_met
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._condition_similarities" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_condition_similarities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._forward_calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_forward_calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._layers_names" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_layers_names
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._layers_states" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_layers_states
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._model_ref" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;_model_ref
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.args" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;args
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.device" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;device
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.enabled" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;enabled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;hooks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.model" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.registered" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;registered
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;tokenizer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.__enter__" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__enter__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.__exit__" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__exit__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._apply_ooi_normalization" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_apply_ooi_normalization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._apply_single_behavior" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_apply_single_behavior
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._cast_pre_hook" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_cast_pre_hook
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._compute_similarity" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_compute_similarity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._process_single_condition" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_process_single_condition
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_setup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST._use_explained_variance_func" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;_use_explained_variance_func
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.get_hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_hooks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.get_model_layer_list" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_model_layer_list
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.register_hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;register_hooks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.remove_hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;remove_hooks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.reset" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;reset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.set_hooks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;set_hooks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control.CAST.steer" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;steer
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                




  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../../../" class="md-path__link">
          
  <span class="md-ellipsis">
    API Reference
  </span>

        </a>
      </li>
    
  

      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../../core/" class="md-path__link">
          
  <span class="md-ellipsis">
    Algorithms
  </span>

        </a>
      </li>
    
  

      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../base_state_control/" class="md-path__link">
          
  <span class="md-ellipsis">
    State control
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="cast">CAST</h1>


<div class="doc doc-object doc-module">



<h2 id="aisteer360.algorithms.state_control.cast" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>aisteer360.algorithms.state_control.cast</code>


</h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">











<div class="doc doc-object doc-module">



<h3 id="aisteer360.algorithms.state_control.cast.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h3>

    <div class="doc doc-contents ">










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="aisteer360.algorithms.state_control.cast.args._check_layer_ids" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">_check_layer_ids</span><span class="p">(</span><span class="n">layer_ids</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Checks validity of layer_ids list</p>
<p>Raises exception if elements are not int and &lt;0, or elements are not unique.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/args.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_check_layer_ids</span><span class="p">(</span><span class="n">layer_ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks validity of layer_ids list</span>

<span class="sd">    Raises exception if elements are not int and &lt;0, or elements are not unique.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer_ids</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid layer_id[</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">]=</span><span class="si">{</span><span class="n">vv</span><span class="si">}</span><span class="s2"> is of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead of int.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid layer_id[</span><span class="si">{</span><span class="n">ii</span><span class="si">}</span><span class="s2">]=</span><span class="si">{</span><span class="n">vv</span><span class="si">}</span><span class="s2"> &lt; 0, should be &gt;=0.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">layer_ids</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer_ids</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">layer_ids</span><span class="si">=}</span><span class="s2"> has duplicate entries. layers ids should be unique&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="aisteer360.algorithms.state_control.cast.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h3>

    <div class="doc doc-contents ">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h4 id="aisteer360.algorithms.state_control.cast.control.CAST" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>CAST</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            StateControl (aisteer360.algorithms.state_control.base.StateControl)" href="../../../library_reference/#aisteer360.algorithms.state_control.base.StateControl">StateControl</a></code></p>



        <p>Implementation of CAST (Conditional Activation Steering) from Lee et al., 2024.</p>
<p>CAST enables selective control of LLM behavior by conditionally applying activation steering based on input context,
allowing fine-grained control without affecting responses to non-targeted content.</p>
<p>The method operates in two phases:</p>
<ol>
<li>
<p><strong>Condition Detection</strong>: Analyzes hidden state activation patterns at specified layers during inference to detect
    if the input matches target conditions. This is done by projecting hidden states onto a condition subspace and
    computing similarity scores against a threshold.</p>
</li>
<li>
<p><strong>Conditional Behavior Modification</strong>: When conditions are met, applies steering vectors to hidden states at
    designated behavior layers. This selectively modifies the model's internal representations to produce desired
    behavioral changes while preserving normal functionality for non-matching inputs.</p>
</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>condition_vector</code>
            </td>
            <td>
                  <code><span title="aisteer360.algorithms.state_control.cast.utils.steering_vector.SteeringVector">SteeringVector</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Steering vector defining the condition subspace for detecting
target input patterns. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>behavior_vector</code>
            </td>
            <td>
                  <code><span title="aisteer360.algorithms.state_control.cast.utils.steering_vector.SteeringVector">SteeringVector</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Steering vector applied to modify behavior when conditions are met.
Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>condition_layer_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Layer indices where condition detection occurs. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>behavior_layer_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Layer indices where behavior modification is applied. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>condition_vector_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Similarity threshold for condition detection. Higher values
require stronger pattern matches. Defaults to 0.5.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>behavior_vector_strength</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scaling factor for the behavior steering vector. Controls the
intensity of behavioral modification. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>condition_comparator_threshold_is</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Comparison mode for threshold ('larger' or 'smaller').
Determines if condition is met when similarity is above or below threshold. Defaults to 'larger'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>condition_threshold_comparison_mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to aggregate hidden states for comparison ('mean'
or 'last'). Defaults to 'mean'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_behavior_on_first_call</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply behavior steering on the first forward pass.
Defaults to True.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_ooi_preventive_normalization</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Apply out-of-distribution preventive normalization to
maintain hidden state magnitudes. Defaults to False.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_explained_variance</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scale steering vectors by their explained variance for adaptive
layer-wise control. Defaults to False.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Reference:</p>
<ul>
<li>"Programming Refusal with Conditional Activation Steering"
Bruce W. Lee, Inkit Padhi, Karthikeyan Natesan Ramamurthy, Erik Miehling, Pierre Dognin, Manish Nagireddy, Amit Dhurandhar
<a href="https://arxiv.org/abs/2409.05907">https://arxiv.org/abs/2409.05907</a></li>
</ul>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CAST</span><span class="p">(</span><span class="n">StateControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of CAST (Conditional Activation Steering) from Lee et al., 2024.</span>

<span class="sd">    CAST enables selective control of LLM behavior by conditionally applying activation steering based on input context,</span>
<span class="sd">    allowing fine-grained control without affecting responses to non-targeted content.</span>

<span class="sd">    The method operates in two phases:</span>

<span class="sd">    1. **Condition Detection**: Analyzes hidden state activation patterns at specified layers during inference to detect</span>
<span class="sd">        if the input matches target conditions. This is done by projecting hidden states onto a condition subspace and</span>
<span class="sd">        computing similarity scores against a threshold.</span>

<span class="sd">    2. **Conditional Behavior Modification**: When conditions are met, applies steering vectors to hidden states at</span>
<span class="sd">        designated behavior layers. This selectively modifies the model&#39;s internal representations to produce desired</span>
<span class="sd">        behavioral changes while preserving normal functionality for non-matching inputs.</span>

<span class="sd">    Args:</span>
<span class="sd">        condition_vector (SteeringVector, optional): Steering vector defining the condition subspace for detecting</span>
<span class="sd">            target input patterns. Defaults to None.</span>
<span class="sd">        behavior_vector (SteeringVector, optional): Steering vector applied to modify behavior when conditions are met.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        condition_layer_ids (list[int], optional): Layer indices where condition detection occurs. Defaults to None.</span>
<span class="sd">        behavior_layer_ids (list[int], optional): Layer indices where behavior modification is applied. Defaults to None.</span>
<span class="sd">        condition_vector_threshold (float, optional): Similarity threshold for condition detection. Higher values</span>
<span class="sd">            require stronger pattern matches. Defaults to 0.5.</span>
<span class="sd">        behavior_vector_strength (float, optional): Scaling factor for the behavior steering vector. Controls the</span>
<span class="sd">            intensity of behavioral modification. Defaults to 1.0.</span>
<span class="sd">        condition_comparator_threshold_is (str, optional): Comparison mode for threshold (&#39;larger&#39; or &#39;smaller&#39;).</span>
<span class="sd">            Determines if condition is met when similarity is above or below threshold. Defaults to &#39;larger&#39;.</span>
<span class="sd">        condition_threshold_comparison_mode (str, optional): How to aggregate hidden states for comparison (&#39;mean&#39;</span>
<span class="sd">            or &#39;last&#39;). Defaults to &#39;mean&#39;.</span>
<span class="sd">        apply_behavior_on_first_call (bool, optional): Whether to apply behavior steering on the first forward pass.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        use_ooi_preventive_normalization (bool, optional): Apply out-of-distribution preventive normalization to</span>
<span class="sd">            maintain hidden state magnitudes. Defaults to False.</span>
<span class="sd">        use_explained_variance (bool, optional): Scale steering vectors by their explained variance for adaptive</span>
<span class="sd">            layer-wise control. Defaults to False.</span>

<span class="sd">    Reference:</span>

<span class="sd">    - &quot;Programming Refusal with Conditional Activation Steering&quot;</span>
<span class="sd">    Bruce W. Lee, Inkit Padhi, Karthikeyan Natesan Ramamurthy, Erik Miehling, Pierre Dognin, Manish Nagireddy, Amit Dhurandhar</span>
<span class="sd">    [https://arxiv.org/abs/2409.05907](https://arxiv.org/abs/2409.05907)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span> <span class="o">=</span> <span class="n">CASTArgs</span>

    <span class="c1"># placeholders</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># layers list reference</span>
    <span class="n">_layers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_layers_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_layers_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">LayerArgs</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Boolean lists for condition and behavior layers</span>
    <span class="n">_condition_layers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_behavior_layers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Logic flags</span>
    <span class="n">_condition_met</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">_forward_calls</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># condition similarity record</span>
    <span class="n">_condition_similarities</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset internal state tracking between generation calls.</span>

<span class="sd">        Clears condition detection flags, forward call counters, and similarity scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_condition_similarities</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">__</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialization by configuring condition detection and behavior modification layers.</span>

<span class="sd">        Sets up steering vectors, condition projectors, and layer-specific parameters for conditional activation</span>
<span class="sd">        steering. Pre-computes projection matrices and behavior vectors.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (PreTrainedModel): The base language model to be steered.</span>
<span class="sd">            tokenizer (PreTrainedTokenizer | None): Tokenizer (currently unused but maintained</span>
<span class="sd">                for API consistency). If None, attempts to retrieve from model attributes.</span>
<span class="sd">            **__: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            PreTrainedModel: The input model, unchanged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_hooks</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">__</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create pre-forward hooks for conditional activation steering.</span>

<span class="sd">        Generates hook specifications for all model layers that will conditionally detect patterns and apply behavior</span>
<span class="sd">        modifications during the forward pass.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids (torch.Tensor): Input token IDs (unused but required by interface).</span>
<span class="sd">            runtime_kwargs (dict | None): Runtime parameters (currently unused).</span>
<span class="sd">            **__: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, list]: Hook specifications with &quot;pre&quot;, &quot;forward&quot;, &quot;backward&quot; keys.</span>
<span class="sd">                Only &quot;pre&quot; hooks are populated with CAST steering logic.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">layer_id</span><span class="p">,</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers_names</span><span class="p">):</span>
            <span class="n">hooks</span><span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">layer_name</span><span class="p">,</span>  <span class="c1"># &quot;model.layers.0&quot;</span>
                    <span class="s2">&quot;hook_func&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cast_pre_hook</span><span class="p">,</span>
                        <span class="n">layer_id</span><span class="o">=</span><span class="n">layer_id</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">hooks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_layer_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract the list of transformer layers from the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (PreTrainedModel): Model to extract layers from.</span>

<span class="sd">        Returns:</span>

<span class="sd">            List of layers for given model</span>
<span class="sd">            List of layers module name prefix for given model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">layers_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">model_layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">):</span>  <span class="c1"># mistral-, llama-, gemma-like models</span>
            <span class="n">model_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span>
            <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s2">&quot;model.layers&quot;</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;transformer&quot;</span><span class="p">):</span>  <span class="c1"># gpt2-like models</span>
            <span class="n">model_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">h</span>
            <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s2">&quot;transformer.h&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Don&#39;t know how to get layer list from model for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_layers</span><span class="p">):</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">layers_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_layers_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">layers</span><span class="p">,</span> <span class="n">layers_names</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure all CAST internals for the given model.</span>

<span class="sd">        Pre-computes steering vectors, condition projectors, and layer configurations to minimize runtime overhead during generation.</span>

<span class="sd">        Process:</span>

<span class="sd">        1. Identifies condition and behavior layers from configuration</span>
<span class="sd">        2. Computes condition projection matrices for detection layers</span>
<span class="sd">        3. Prepares scaled behavior vectors for modification layers</span>
<span class="sd">        4. Stores layer-specific parameters in _layer_states</span>

<span class="sd">        Args:</span>
<span class="sd">            model (PreTrainedModel): Model to configure CAST for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_layer_list</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">num_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers</span><span class="p">)</span>

        <span class="c1"># Creating dicts for condition and behavior layers</span>
        <span class="n">condition_layers</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_layers</span>
        <span class="n">behavior_layers</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_layers</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span><span class="p">:</span>
                <span class="n">condition_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_layer_ids</span><span class="p">:</span>
                <span class="n">behavior_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">condition_layers</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_behavior_layers</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">behavior_layers</span><span class="p">)}</span>

        <span class="c1"># Precompute behavior vectors and condition projectors</span>
        <span class="n">condition_layer_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">behavior_layer_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_layer_ids</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
            <span class="c1"># layer = self._layers[layer_id]</span>
            <span class="n">behavior_tensor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="n">behavior_layer_ids_set</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_explained_variance</span><span class="p">:</span>
                        <span class="n">behavior_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_explained_variance_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">behavior_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

                    <span class="n">behavior_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector_strength</span> <span class="o">*</span> <span class="n">behavior_direction</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="n">condition_projector</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="n">condition_layer_ids_set</span><span class="p">:</span>
                <span class="n">condition_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_explained_variance</span><span class="p">:</span>
                    <span class="n">condition_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_explained_variance_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">condition_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

                <span class="n">condition_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">condition_direction</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">condition_projector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ger</span><span class="p">(</span><span class="n">condition_tensor</span><span class="p">,</span> <span class="n">condition_tensor</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">condition_tensor</span><span class="p">,</span> <span class="n">condition_tensor</span><span class="p">)</span>

            <span class="n">layer_control_params</span> <span class="o">=</span> <span class="n">LayerControlParams</span><span class="p">()</span>

            <span class="n">layer_args</span> <span class="o">=</span> <span class="n">LayerArgs</span><span class="p">(</span>
                <span class="n">behavior_vector</span><span class="o">=</span><span class="n">behavior_tensor</span><span class="p">,</span>
                <span class="n">condition_projector</span><span class="o">=</span><span class="n">condition_projector</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_vector_threshold</span><span class="p">,</span>
                <span class="n">use_ooi_preventive_normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ooi_preventive_normalization</span><span class="p">,</span>
                <span class="n">apply_behavior_on_first_call</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_behavior_on_first_call</span><span class="p">,</span>
                <span class="n">condition_comparator_threshold_is</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span><span class="p">,</span>
                <span class="n">condition_threshold_comparison_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_threshold_comparison_mode</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">layer_control_params</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_args</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_use_explained_variance_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">SteeringVector</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scale steering vector by its explained variance for adaptive control.</span>

<span class="sd">        This method scales the steering vector based on its explained variance,</span>
<span class="sd">        potentially adjusting its impact on different layers of the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            vector (SteeringVector): Steering vector containing directions and variances.</span>
<span class="sd">            layer_id (int): Layer index to retrieve variance scaling for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Direction vector scaled by explained variance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="s1">&#39;explained_variances&#39;</span><span class="p">):</span>
            <span class="n">variance_scale</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">explained_variances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">variance_scale</span>

        <span class="k">return</span> <span class="n">direction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cast_pre_hook</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module</span><span class="p">,</span>
        <span class="n">input_args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
        <span class="n">input_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply conditional activation steering as a pre-forward hook.</span>

<span class="sd">        Detect conditions and applies behavior modifications during the model&#39;s forward pass. Processes each layer</span>
<span class="sd">        independently based on its configuration.</span>

<span class="sd">        Process:</span>

<span class="sd">        1. Extract hidden states from arguments</span>
<span class="sd">        2. If condition layer: detect if input matches target pattern</span>
<span class="sd">        3. If behavior layer and conditions met: apply steering vector</span>
<span class="sd">        4. Optionally apply OOI normalization to prevent distribution shift</span>

<span class="sd">        Args:</span>
<span class="sd">            module: The layer module being hooked.</span>
<span class="sd">            input_args: Positional arguments to the forward pass.</span>
<span class="sd">            input_kwargs: Keyword arguments to the forward pass.</span>
<span class="sd">            layer_id (int): Index of the current layer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of potentially modified (input_args, input_kwargs).</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If hidden states cannot be located.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">input_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">input_args</span> <span class="k">else</span> <span class="n">input_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hidden_states</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;CAST: could not locate hidden states&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_length</span><span class="p">,</span> <span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># CASE 1 -&gt; no steering</span>
            <span class="n">is_condition_layer</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">is_behavior_layer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># CASE 2 -&gt; steering</span>
            <span class="n">is_condition_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>
            <span class="n">is_behavior_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_behavior_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

        <span class="n">original_norm</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_condition_layer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_single_condition</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">layer_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_behavior_layer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_single_behavior</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ooi_preventive_normalization</span> <span class="ow">and</span> <span class="n">is_behavior_layer</span><span class="p">:</span>
            <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ooi_normalization</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">original_norm</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_args</span><span class="p">:</span>
            <span class="n">input_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_args</span><span class="p">)</span>
            <span class="n">input_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hidden_states</span>
            <span class="n">my_input_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">input_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">my_input_args</span> <span class="o">=</span> <span class="n">input_args</span>
            <span class="n">input_kwargs</span><span class="p">[</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hidden_states</span>

        <span class="k">return</span> <span class="n">my_input_args</span><span class="p">,</span> <span class="n">input_kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_single_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_state</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect if input matches target condition pattern.</span>

<span class="sd">        Projects hidden states onto condition subspace and compares similarity against threshold to determine if</span>
<span class="sd">        steering should be activated.</span>

<span class="sd">        Process:</span>

<span class="sd">        1. Aggregate hidden states (mean or last token based on config)</span>
<span class="sd">        2. Project onto condition subspace using precomputed projector</span>
<span class="sd">        3. Compute cosine similarity between original and projected</span>
<span class="sd">        4. Compare against threshold with specified comparator</span>

<span class="sd">        Args:</span>
<span class="sd">            hidden_state: Hidden state tensor to analyze [seq_len, hidden_dim].</span>
<span class="sd">            layer_id (int): Current layer index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_threshold_comparison_mode</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                <span class="n">hidden_state</span> <span class="o">=</span> <span class="n">hidden_state</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_threshold_comparison_mode</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
                <span class="n">hidden_state</span> <span class="o">=</span> <span class="n">hidden_state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">projected_hidden_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layer_args</span><span class="o">.</span><span class="n">condition_projector</span><span class="p">,</span> <span class="n">hidden_state</span><span class="p">))</span>
            <span class="n">condition_similarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_similarity</span><span class="p">(</span><span class="n">hidden_state</span><span class="p">,</span> <span class="n">projected_hidden_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_condition_similarities</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_similarity</span>

            <span class="k">if</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span> <span class="o">==</span> <span class="s2">&quot;smaller&quot;</span><span class="p">:</span>
                <span class="n">condition_met</span> <span class="o">=</span> <span class="p">(</span><span class="n">condition_similarity</span> <span class="o">&gt;=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span> <span class="o">==</span> <span class="s2">&quot;larger&quot;</span><span class="p">:</span>
                <span class="n">condition_met</span> <span class="o">=</span> <span class="p">(</span><span class="n">condition_similarity</span> <span class="o">&lt;</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_met</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer </span><span class="si">{</span><span class="n">layer_id</span><span class="si">}</span><span class="s2">:  similarity: </span><span class="si">{</span><span class="n">condition_similarity</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;threshold: </span><span class="si">{</span><span class="n">layer_args</span><span class="o">.</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;condition comparator threshold &#39;</span><span class="si">{</span><span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span><span class="si">}</span><span class="s2">&#39; -- &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;Condition Met: </span><span class="si">{</span><span class="n">condition_met</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_single_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply behavior steering vector when conditions are met.</span>

<span class="sd">        Modifies hidden states by adding scaled steering vectors to shift model behavior toward desired outputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            hidden_states: Hidden states to modify [batch, seq_len, hidden_dim].</span>
<span class="sd">            layer_id (int): Current layer index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

        <span class="n">should_apply</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># print(f&quot;Should Apply Behavior: {should_apply}&quot;)</span>

        <span class="k">if</span> <span class="n">should_apply</span><span class="p">:</span>
            <span class="n">control</span> <span class="o">=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">behavior_vector</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">hidden_states</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">apply_behavior_on_first_call</span><span class="p">:</span>
                    <span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">operator</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">control</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;apply_behavior_on_first_call is False, skipping behavior vector application&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">operator</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">control</span><span class="p">)</span>
                <span class="c1"># print(f&quot;{layer_id=}: Applying behavior vector to all tokens&quot;)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the cosine similarity between two tensors.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: First tensor.</span>
<span class="sd">            y: Second tensor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The cosine similarity as a float.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cossim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">cossim</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_ooi_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">,</span> <span class="n">original_norm</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply out-of-distribution preventive normalization.</span>

<span class="sd">        Prevents hidden states from drifting too far from original distribution by rescaling to maintain norm magnitudes after steering.</span>

<span class="sd">        Args:</span>
<span class="sd">            hidden_states: Modified hidden states to normalize.</span>
<span class="sd">            original_norm: Original norm before modifications.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Normalized hidden states.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If NaN or Inf detected in hidden states.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_norm</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_norm</span> <span class="o">/</span> <span class="n">original_norm</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">has_nan_inf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">has_nan_inf</span><span class="p">:</span>
            <span class="c1"># NaN propagates, decided to raise instead of just applying norm as in original code.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaN: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2"> or Inf: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2"> dectected in hidden_states&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">has_nan_inf</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying OOI preventive normalization. Max_ratio was </span><span class="si">{</span><span class="n">max_ratio</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">hidden_states</span> <span class="o">*</span> <span class="p">(</span><span class="n">original_norm</span> <span class="o">/</span> <span class="n">new_norm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No OOI preventive normalization. Max_ratio was </span><span class="si">{</span><span class="n">max_ratio</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hidden_states</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._behavior_layers" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">_behavior_layers</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._condition_layers" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">_condition_layers</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._condition_met" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">_condition_met</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._condition_similarities" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">_condition_similarities</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._forward_calls" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">_forward_calls</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._layers" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">_layers</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._layers_names" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">_layers_names</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._layers_states" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">_layers_states</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._model_ref" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">_model_ref</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pre&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;forward&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span> <span class="p">[]}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.registered" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">registered</span> <span class="o">=</span> <span class="p">[]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.__enter__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="fm">__enter__</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Context manager entry: register hooks to model.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If model reference not set by pipeline</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager entry: register hooks to model.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If model reference not set by pipeline</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model reference not set before entering context.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_hooks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ref</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.__exit__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Context manager exit: clean up all hooks.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager exit: clean up all hooks.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">remove_hooks</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># null control</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> accepts no constructor arguments.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span> <span class="n">BaseArgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># move fields to attributes</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">RemovableHandle</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._apply_ooi_normalization" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">_apply_ooi_normalization</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">original_norm</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Apply out-of-distribution preventive normalization.</p>
<p>Prevents hidden states from drifting too far from original distribution by rescaling to maintain norm magnitudes after steering.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Modified hidden states to normalize.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>original_norm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original norm before modifications.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>torch.Tensor: Normalized hidden states.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If NaN or Inf detected in hidden states.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_apply_ooi_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">,</span> <span class="n">original_norm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply out-of-distribution preventive normalization.</span>

<span class="sd">    Prevents hidden states from drifting too far from original distribution by rescaling to maintain norm magnitudes after steering.</span>

<span class="sd">    Args:</span>
<span class="sd">        hidden_states: Modified hidden states to normalize.</span>
<span class="sd">        original_norm: Original norm before modifications.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Normalized hidden states.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If NaN or Inf detected in hidden states.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_norm</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">max_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_norm</span> <span class="o">/</span> <span class="n">original_norm</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">has_nan_inf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">has_nan_inf</span><span class="p">:</span>
        <span class="c1"># NaN propagates, decided to raise instead of just applying norm as in original code.</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaN: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2"> or Inf: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2"> dectected in hidden_states&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">max_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">has_nan_inf</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying OOI preventive normalization. Max_ratio was </span><span class="si">{</span><span class="n">max_ratio</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">hidden_states</span> <span class="o">*</span> <span class="p">(</span><span class="n">original_norm</span> <span class="o">/</span> <span class="n">new_norm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No OOI preventive normalization. Max_ratio was </span><span class="si">{</span><span class="n">max_ratio</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hidden_states</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._apply_single_behavior" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">_apply_single_behavior</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Apply behavior steering vector when conditions are met.</p>
<p>Modifies hidden states by adding scaled steering vectors to shift model behavior toward desired outputs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hidden_states</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hidden states to modify [batch, seq_len, hidden_dim].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current layer index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_apply_single_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply behavior steering vector when conditions are met.</span>

<span class="sd">    Modifies hidden states by adding scaled steering vectors to shift model behavior toward desired outputs.</span>

<span class="sd">    Args:</span>
<span class="sd">        hidden_states: Hidden states to modify [batch, seq_len, hidden_dim].</span>
<span class="sd">        layer_id (int): Current layer index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

    <span class="n">should_apply</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># print(f&quot;Should Apply Behavior: {should_apply}&quot;)</span>

    <span class="k">if</span> <span class="n">should_apply</span><span class="p">:</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">behavior_vector</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">hidden_states</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">apply_behavior_on_first_call</span><span class="p">:</span>
                <span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">operator</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">control</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;apply_behavior_on_first_call is False, skipping behavior vector application&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">operator</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">control</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._cast_pre_hook" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">_cast_pre_hook</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">input_args</span><span class="p">,</span> <span class="n">input_kwargs</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Apply conditional activation steering as a pre-forward hook.</p>
<p>Detect conditions and applies behavior modifications during the model's forward pass. Processes each layer
independently based on its configuration.</p>
<p>Process:</p>
<ol>
<li>Extract hidden states from arguments</li>
<li>If condition layer: detect if input matches target pattern</li>
<li>If behavior layer and conditions met: apply steering vector</li>
<li>Optionally apply OOI normalization to prevent distribution shift</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>module</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The layer module being hooked.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>input_args</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Positional arguments to the forward pass.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>input_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keyword arguments to the forward pass.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Index of the current layer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of potentially modified (input_args, input_kwargs).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If hidden states cannot be located.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_cast_pre_hook</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">module</span><span class="p">,</span>
    <span class="n">input_args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">input_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply conditional activation steering as a pre-forward hook.</span>

<span class="sd">    Detect conditions and applies behavior modifications during the model&#39;s forward pass. Processes each layer</span>
<span class="sd">    independently based on its configuration.</span>

<span class="sd">    Process:</span>

<span class="sd">    1. Extract hidden states from arguments</span>
<span class="sd">    2. If condition layer: detect if input matches target pattern</span>
<span class="sd">    3. If behavior layer and conditions met: apply steering vector</span>
<span class="sd">    4. Optionally apply OOI normalization to prevent distribution shift</span>

<span class="sd">    Args:</span>
<span class="sd">        module: The layer module being hooked.</span>
<span class="sd">        input_args: Positional arguments to the forward pass.</span>
<span class="sd">        input_kwargs: Keyword arguments to the forward pass.</span>
<span class="sd">        layer_id (int): Index of the current layer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of potentially modified (input_args, input_kwargs).</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If hidden states cannot be located.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">input_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">input_args</span> <span class="k">else</span> <span class="n">input_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hidden_states</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;CAST: could not locate hidden states&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_length</span><span class="p">,</span> <span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># CASE 1 -&gt; no steering</span>
        <span class="n">is_condition_layer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">is_behavior_layer</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># CASE 2 -&gt; steering</span>
        <span class="n">is_condition_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>
        <span class="n">is_behavior_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_behavior_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

    <span class="n">original_norm</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_condition_layer</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_single_condition</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">layer_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_behavior_layer</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_single_behavior</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ooi_preventive_normalization</span> <span class="ow">and</span> <span class="n">is_behavior_layer</span><span class="p">:</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ooi_normalization</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">original_norm</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">input_args</span><span class="p">:</span>
        <span class="n">input_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_args</span><span class="p">)</span>
        <span class="n">input_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hidden_states</span>
        <span class="n">my_input_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">input_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">my_input_args</span> <span class="o">=</span> <span class="n">input_args</span>
        <span class="n">input_kwargs</span><span class="p">[</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hidden_states</span>

    <span class="k">return</span> <span class="n">my_input_args</span><span class="p">,</span> <span class="n">input_kwargs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._compute_similarity" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">_compute_similarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Compute the cosine similarity between two tensors.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First tensor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second tensor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The cosine similarity as a float.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_compute_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the cosine similarity between two tensors.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: First tensor.</span>
<span class="sd">        y: Second tensor.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The cosine similarity as a float.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cossim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">cossim</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._process_single_condition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">_process_single_condition</span><span class="p">(</span><span class="n">hidden_state</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Detect if input matches target condition pattern.</p>
<p>Projects hidden states onto condition subspace and compares similarity against threshold to determine if
steering should be activated.</p>
<p>Process:</p>
<ol>
<li>Aggregate hidden states (mean or last token based on config)</li>
<li>Project onto condition subspace using precomputed projector</li>
<li>Compute cosine similarity between original and projected</li>
<li>Compare against threshold with specified comparator</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hidden_state</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hidden state tensor to analyze [seq_len, hidden_dim].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current layer index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_process_single_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_state</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect if input matches target condition pattern.</span>

<span class="sd">    Projects hidden states onto condition subspace and compares similarity against threshold to determine if</span>
<span class="sd">    steering should be activated.</span>

<span class="sd">    Process:</span>

<span class="sd">    1. Aggregate hidden states (mean or last token based on config)</span>
<span class="sd">    2. Project onto condition subspace using precomputed projector</span>
<span class="sd">    3. Compute cosine similarity between original and projected</span>
<span class="sd">    4. Compare against threshold with specified comparator</span>

<span class="sd">    Args:</span>
<span class="sd">        hidden_state: Hidden state tensor to analyze [seq_len, hidden_dim].</span>
<span class="sd">        layer_id (int): Current layer index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layer_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_threshold_comparison_mode</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">hidden_state</span> <span class="o">=</span> <span class="n">hidden_state</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_threshold_comparison_mode</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
            <span class="n">hidden_state</span> <span class="o">=</span> <span class="n">hidden_state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">projected_hidden_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layer_args</span><span class="o">.</span><span class="n">condition_projector</span><span class="p">,</span> <span class="n">hidden_state</span><span class="p">))</span>
        <span class="n">condition_similarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_similarity</span><span class="p">(</span><span class="n">hidden_state</span><span class="p">,</span> <span class="n">projected_hidden_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_condition_similarities</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_similarity</span>

        <span class="k">if</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span> <span class="o">==</span> <span class="s2">&quot;smaller&quot;</span><span class="p">:</span>
            <span class="n">condition_met</span> <span class="o">=</span> <span class="p">(</span><span class="n">condition_similarity</span> <span class="o">&gt;=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span> <span class="o">==</span> <span class="s2">&quot;larger&quot;</span><span class="p">:</span>
            <span class="n">condition_met</span> <span class="o">=</span> <span class="p">(</span><span class="n">condition_similarity</span> <span class="o">&lt;</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_met</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer </span><span class="si">{</span><span class="n">layer_id</span><span class="si">}</span><span class="s2">:  similarity: </span><span class="si">{</span><span class="n">condition_similarity</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;threshold: </span><span class="si">{</span><span class="n">layer_args</span><span class="o">.</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;condition comparator threshold &#39;</span><span class="si">{</span><span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span><span class="si">}</span><span class="s2">&#39; -- &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Condition Met: </span><span class="si">{</span><span class="n">condition_met</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._setup" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">_setup</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Configure all CAST internals for the given model.</p>
<p>Pre-computes steering vectors, condition projectors, and layer configurations to minimize runtime overhead during generation.</p>
<p>Process:</p>
<ol>
<li>Identifies condition and behavior layers from configuration</li>
<li>Computes condition projection matrices for detection layers</li>
<li>Prepares scaled behavior vectors for modification layers</li>
<li>Stores layer-specific parameters in _layer_states</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model to configure CAST for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure all CAST internals for the given model.</span>

<span class="sd">    Pre-computes steering vectors, condition projectors, and layer configurations to minimize runtime overhead during generation.</span>

<span class="sd">    Process:</span>

<span class="sd">    1. Identifies condition and behavior layers from configuration</span>
<span class="sd">    2. Computes condition projection matrices for detection layers</span>
<span class="sd">    3. Prepares scaled behavior vectors for modification layers</span>
<span class="sd">    4. Stores layer-specific parameters in _layer_states</span>

<span class="sd">    Args:</span>
<span class="sd">        model (PreTrainedModel): Model to configure CAST for.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_layer_list</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">num_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers</span><span class="p">)</span>

    <span class="c1"># Creating dicts for condition and behavior layers</span>
    <span class="n">condition_layers</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_layers</span>
    <span class="n">behavior_layers</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_layers</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span><span class="p">:</span>
            <span class="n">condition_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_layer_ids</span><span class="p">:</span>
            <span class="n">behavior_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">condition_layers</span><span class="p">)}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_behavior_layers</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">behavior_layers</span><span class="p">)}</span>

    <span class="c1"># Precompute behavior vectors and condition projectors</span>
    <span class="n">condition_layer_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">behavior_layer_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_layer_ids</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
        <span class="c1"># layer = self._layers[layer_id]</span>
        <span class="n">behavior_tensor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="n">behavior_layer_ids_set</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_explained_variance</span><span class="p">:</span>
                    <span class="n">behavior_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_explained_variance_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">behavior_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

                <span class="n">behavior_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector_strength</span> <span class="o">*</span> <span class="n">behavior_direction</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">condition_projector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="n">condition_layer_ids_set</span><span class="p">:</span>
            <span class="n">condition_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_explained_variance</span><span class="p">:</span>
                <span class="n">condition_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_explained_variance_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">condition_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

            <span class="n">condition_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">condition_direction</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">condition_projector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ger</span><span class="p">(</span><span class="n">condition_tensor</span><span class="p">,</span> <span class="n">condition_tensor</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">condition_tensor</span><span class="p">,</span> <span class="n">condition_tensor</span><span class="p">)</span>

        <span class="n">layer_control_params</span> <span class="o">=</span> <span class="n">LayerControlParams</span><span class="p">()</span>

        <span class="n">layer_args</span> <span class="o">=</span> <span class="n">LayerArgs</span><span class="p">(</span>
            <span class="n">behavior_vector</span><span class="o">=</span><span class="n">behavior_tensor</span><span class="p">,</span>
            <span class="n">condition_projector</span><span class="o">=</span><span class="n">condition_projector</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_vector_threshold</span><span class="p">,</span>
            <span class="n">use_ooi_preventive_normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ooi_preventive_normalization</span><span class="p">,</span>
            <span class="n">apply_behavior_on_first_call</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_behavior_on_first_call</span><span class="p">,</span>
            <span class="n">condition_comparator_threshold_is</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span><span class="p">,</span>
            <span class="n">condition_threshold_comparison_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_threshold_comparison_mode</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">layer_control_params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_args</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST._use_explained_variance_func" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">_use_explained_variance_func</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Scale steering vector by its explained variance for adaptive control.</p>
<p>This method scales the steering vector based on its explained variance,
potentially adjusting its impact on different layers of the model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vector</code>
            </td>
            <td>
                  <code><span title="aisteer360.algorithms.state_control.cast.utils.steering_vector.SteeringVector">SteeringVector</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Steering vector containing directions and variances.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>layer_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Layer index to retrieve variance scaling for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.ndarray: Direction vector scaled by explained variance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_use_explained_variance_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">SteeringVector</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scale steering vector by its explained variance for adaptive control.</span>

<span class="sd">    This method scales the steering vector based on its explained variance,</span>
<span class="sd">    potentially adjusting its impact on different layers of the model.</span>

<span class="sd">    Args:</span>
<span class="sd">        vector (SteeringVector): Steering vector containing directions and variances.</span>
<span class="sd">        layer_id (int): Layer index to retrieve variance scaling for.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Direction vector scaled by explained variance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="s1">&#39;explained_variances&#39;</span><span class="p">):</span>
        <span class="n">variance_scale</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">explained_variances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">variance_scale</span>

    <span class="k">return</span> <span class="n">direction</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.get_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_hooks</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Create pre-forward hooks for conditional activation steering.</p>
<p>Generates hook specifications for all model layers that will conditionally detect patterns and apply behavior
modifications during the forward pass.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input token IDs (unused but required by interface).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runtime parameters (currently unused).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**__</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict[str, list]: Hook specifications with "pre", "forward", "backward" keys.
Only "pre" hooks are populated with CAST steering logic.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_hooks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">__</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create pre-forward hooks for conditional activation steering.</span>

<span class="sd">    Generates hook specifications for all model layers that will conditionally detect patterns and apply behavior</span>
<span class="sd">    modifications during the forward pass.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids (torch.Tensor): Input token IDs (unused but required by interface).</span>
<span class="sd">        runtime_kwargs (dict | None): Runtime parameters (currently unused).</span>
<span class="sd">        **__: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, list]: Hook specifications with &quot;pre&quot;, &quot;forward&quot;, &quot;backward&quot; keys.</span>
<span class="sd">            Only &quot;pre&quot; hooks are populated with CAST steering logic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">for</span> <span class="n">layer_id</span><span class="p">,</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers_names</span><span class="p">):</span>
        <span class="n">hooks</span><span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">layer_name</span><span class="p">,</span>  <span class="c1"># &quot;model.layers.0&quot;</span>
                <span class="s2">&quot;hook_func&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cast_pre_hook</span><span class="p">,</span>
                    <span class="n">layer_id</span><span class="o">=</span><span class="n">layer_id</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">hooks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.get_model_layer_list" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_model_layer_list</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Extract the list of transformer layers from the model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model to extract layers from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:</p>
<pre><code>List of layers for given model
List of layers module name prefix for given model
</code></pre>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_model_layer_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract the list of transformer layers from the model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (PreTrainedModel): Model to extract layers from.</span>

<span class="sd">    Returns:</span>

<span class="sd">        List of layers for given model</span>
<span class="sd">        List of layers module name prefix for given model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">layers_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">model_layers</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">):</span>  <span class="c1"># mistral-, llama-, gemma-like models</span>
        <span class="n">model_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span>
        <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s2">&quot;model.layers&quot;</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;transformer&quot;</span><span class="p">):</span>  <span class="c1"># gpt2-like models</span>
        <span class="n">model_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">h</span>
        <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s2">&quot;transformer.h&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Don&#39;t know how to get layer list from model for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_layers</span><span class="p">):</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">layers_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_layers_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">layers</span><span class="p">,</span> <span class="n">layers_names</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.register_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">register_hooks</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Attach hooks to model.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attach hooks to model.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="s2">&quot;backward&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="n">phase</span><span class="p">]:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_submodule</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;pre&quot;</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_forward_pre_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">],</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">],</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_full_backward_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.remove_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">remove_hooks</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Remove all registered hooks from the model.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove all registered hooks from the model.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="p">:</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.reset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">reset</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Reset internal state tracking between generation calls.</p>
<p>Clears condition detection flags, forward call counters, and similarity scores.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset internal state tracking between generation calls.</span>

<span class="sd">    Clears condition detection flags, forward call counters, and similarity scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_condition_similarities</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.set_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">set_hooks</span><span class="p">(</span><span class="n">hooks</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Update the hook specifications to be registered.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the hook specifications to be registered.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">hooks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.algorithms.state_control.cast.control.CAST.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Initialization by configuring condition detection and behavior modification layers.</p>
<p>Sets up steering vectors, condition projectors, and layer-specific parameters for conditional activation
steering. Pre-computes projection matrices and behavior vectors.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base language model to be steered.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizer">PreTrainedTokenizer</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer (currently unused but maintained
for API consistency). If None, attempts to retrieve from model attributes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**__</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>PreTrainedModel</code></td>            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input model, unchanged.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">__</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialization by configuring condition detection and behavior modification layers.</span>

<span class="sd">    Sets up steering vectors, condition projectors, and layer-specific parameters for conditional activation</span>
<span class="sd">    steering. Pre-computes projection matrices and behavior vectors.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (PreTrainedModel): The base language model to be steered.</span>
<span class="sd">        tokenizer (PreTrainedTokenizer | None): Tokenizer (currently unused but maintained</span>
<span class="sd">            for API consistency). If None, attempts to retrieve from model attributes.</span>
<span class="sd">        **__: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        PreTrainedModel: The input model, unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../base_state_control/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Base classes">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Base classes
              </div>
            </div>
          </a>
        
        
          
          <a href="../pasta/" class="md-footer__link md-footer__link--next" aria-label="Next: PASTA">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                PASTA
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["content.tabs.link", "content.code.annotate", "content.code.copy", "announce.dismiss", "navigation.footer", "navigation.tabs", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.top", "navigation.tracking", "search.suggest", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>